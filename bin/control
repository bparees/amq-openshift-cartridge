#!/bin/bash
source $OPENSHIFT_CARTRIDGE_SDK_BASH

AMQ_BIN_DIR=${OPENSHIFT_AMQ_DIR}container/bin
AMQ_PID_FILE=${OPENSHIFT_AMQ_DIR}container/instances/instance.properties

function start() {
  if is_running; then
      client_result "AMQ cart already started"
  else
    ${AMQ_BIN_DIR}/start
    wait_for_start    
    client_result "Started JBoss AMQ cart"
  fi
}

function stop() {
    if [ -f $AMQ_PID_FILE ]; then
        PID=`cat $AMQ_PID_FILE | grep "item.0.pid" | awk -F " = " '{print $2}'`
        ${AMQ_BIN_DIR}/stop
        for i in {1..20};
            do
                if ps -p $PID > /dev/null; then
                    echo "JBoss AMQ has been successfully stopped"
                    rm $AMQ_PID_FILE
                    break
                else
                    sleep 3
                fi
            done
        client_result "Stopped JBoss AMQ cart"
    else
        echo "JBoss AMQ cart was stopped already"
    fi
}

function restart() {
    if is_running; then
        stop
    fi
    start
}

function status() {
   if is_running; then
      client_result "Application is running"
   else
      client_result "Application is either stopped or inaccessible"
   fi
}

function reload() {
    client_message "Reloading JBoss AMQ cart"
    restart
}

function tidy() {
  client_message "Emptying log dir: $OPENSHIFT_AMQ_LOG_DIR"
  shopt -s dotglob
  rm -rf $OPENSHIFT_AMQ_LOG_DIR/*
}

function is_running() {
   #Check if instance file exists
   if [ ! -f $AMQ_PID_FILE ]; then
      return 1
   fi

   #Check if pid exists
   PID=`cat $AMQ_PID_FILE | grep "item.0.pid" | awk -F " = " '{print $2}'`
   if [ "$PID" = "" ]; then
      return 1
   elif ps -p $PID > /dev/null; then
      return 0
   else
      rm $AMQ_PID_FILE
      return 1
   fi
}

function wait_for_start() {
  for i in {1..20};
     do
       if [ ! -f $AMQ_PID_FILE ]; then
         sleep 1
       else
         break
       fi
     done
   if [ -f $AMQ_PID_FILE ]; then
      for j in {1..20};
         do
           PID=`cat $AMQ_PID_FILE | grep "item.0.pid" | awk -F "=" '{print $2}'`
           if [ "$PID" = "" ]; then
             sleep 1
           else
            break
           fi
     done
     if ps -p $PID > /dev/null; then
       client_result "JBoss AMQ($PID) is started successfully"
     else
       client_error "Command Failed: JBoss AMQ process ($PID) is not running"
     fi
   else
    client_error "Command Failed:Could not find JBoss AMQ instance.properties"
   fi
}

function deploy() {
  echo "deployed"
}

function threaddump() {
  echo "Thread dump for A-MQ cartridge"

    if ! is_running; then
        echo "Application is stopped"
    elif [ -f "$AMQ_PID_FILE" ]; then
        pid=`cat $AMQ_PID_FILE | grep "item.0.pid" | awk -F " = " '{print $2}'`
        jstack -l $pid > $OPENSHIFT_AMQ_LOG_DIR/threaddump.log
        client_result "Success"
        client_result ""
        client_result "The thread dump file will be available via: rhc tail $OPENSHIFT_APP_NAME -g $OPENSHIFT_GEAR_UUID -f ${OPENSHIFT_AMQ_LOG_DIR}threaddump.log -o '-n 250'"
    else 
        echo "Failed to locate A-MQ PID File"
    fi
}

case "$1" in
  deploy)    deploy ;;
  start)     start ;;
  stop)      stop ;;
  restart)   restart ;;
  status)    status ;;
  reload)    reload ;;
  tidy)      tidy ;;
  threaddump)      threaddump ;;
  *)         exit 0
esac
